services:
  distribuitioncenter-api:
    build:
      context: ./DistribuitionCenter.API
      dockerfile: /Dockerfile
    ports:
      - "5000:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ConnectionStrings__PostgresConnection=Host=postgres;Database=ordersdb;Username=root;Password=password
      - Kafka__BootstrapServers=kafka:9092
      - Jaeger__AgentHost=jaeger
      - Jaeger__AgentPort=6831
    depends_on:
      - postgres
      - kafka
      - jaeger

  order-api:
    build:
      context: ./OrderSolution.API
      dockerfile: /Dockerfile
    ports:
      - "5000:8081"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ConnectionStrings__PostgresConnection=Host=postgres;Database=ordersdb;Username=root;Password=password
      - Kafka__BootstrapServers=kafka:9092
      - Jaeger__AgentHost=jaeger
      - Jaeger__AgentPort=6831
    depends_on:
      - postgres
      - kafka
      - jaeger

  order-consumer:
    build:
      context: ./OrdersSolution.RetryConsumer
      dockerfile: /Dockerfile
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ConnectionStrings__PostgresConnection=Host=postgres;Database=ordersdb;Username=root;Password=password
      - Kafka__BootstrapServers=kafka:9092
      - Jaeger__AgentHost=jaeger
      - Jaeger__AgentPort=6831
    depends_on:
      - kafka
      - postgres
      - jaeger

  kafka:
    image: confluentinc/cp-kafka:latest
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    depends_on:
      - zookeeper

  zookeeper:
    image: confluentinc/cp-zookeeper:latest
    ports:
      - "2181:2181"
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000

  postgres:
    image: postgres:latest
    environment:
      POSTGRES_USER: root
      POSTGRES_PASSWORD: password
      POSTGRES_DB: OrdersDB
    ports:
      - "5432:5432"
    # volumes:
    #   - postgres-data:/var/lib/postgresql/data

  pgadmin:
    image: dpage/pgadmin4
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@admin.com
      PGADMIN_DEFAULT_PASSWORD: admin
    ports:
      - "8080:8083"
    depends_on:
      - postgres

  jaeger:
    image: jaegertracing/all-in-one:latest
    ports:
      - "16686:16686"   # Interface Web do Jaeger
      - "6831:6831/udp" # Porta de coleta de dados do Jaeger
      - "6832:6832/udp" # Porta de coleta de dados do Jaeger para outros protocolos
    environment:
      - COLLECTOR_ZIPKIN_HTTP_PORT=9411
